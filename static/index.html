<!DOCTYPE html>
<html>
  <head>
    <title>I Fart Radio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <style>
    	body {
    		padding-top: 70px;
    	}
    </style>
  </head>
  <body>
  	<div class="navbar navbar-fixed-top">
  		<a class="navbar-brand" href="/">I Fart Radio</a>
	</div>
	<div class="container">
	</div>

    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/moment.min.js"></script>
    <script>

    function appendStation(source) {
    	var row = $('<div class="row"></div>');
    	row.append('<div class="col-lg-1 well"><img src="' + source.logo + '" width="100%" /></div>');
    	row.append('<div class="col-lg-6"><h3>' + source.name + '</h3 ></div>');
    	$(".container").append(row);
    }


    $(document).ready(function() {
    	var one_hour_ago = moment.utc().subtract('minutes', 3);
    	var query = {
    		"query": {
	    		"has_children": {
	    			"type": "play",
	    			"query": {
	    				"range": {
	    					"_timestamp": {
	    						"from": one_hour_ago.format(),
	    					}
	    				}
	    			}
	    		}
    		}
		};
    	$.ajax(
    		"http://" + document.domain + ":9200/radio/station/_search?size=50",
    		{
    			type: "GET",
    			data: JSON.stringify(query),
    			success: function(data) {
    				$(".container").append('<div class="row"><h4>Currently playing <span class="label label-default">' + data.hits.total + '</span></h4></div>');
    				for (var i=0;i<data.hits.hits.length;i++){
    					console.log(data.hits.hits[i]);
    					appendStation(data.hits.hits[i]['_source']);
    				} 
    			}
    		}
    	);
	});
    </script>
  </body>
</html>